# Demo 1 - Securing Services with Mutual TLS

Encrypting traffic between services with TLS and requiring a client certificate.

## 1.0 Pre-reqs

Deploy Istio, bookinfo & legacy app:

```
kubectl apply -f ../setup/
```

> The [legacy app deployment](../setup/06_sleep.yaml) is not running through Istio

## 1.1 Hack the details API

Check default mesh policy:

```
kubectl describe meshpolicy default
```

Find the legacy app container:

```
docker container ls --filter name=k8s_sleep

$id=$(docker container ls --filter name=k8s_sleep --format '{{ .ID}}')
```

Run a shell in the container:

```
docker container exec -it $id sh
```

Use the details API:

```
curl http://details.default.svc.cluster.local:9080/details/1

curl http://details.default.svc.cluster.local:9080/details/100
```

## 1.2 Secure the bookinfo services

> In a new session

Enforce mTLS for [all services in the default namespace](mutual-tls.yaml):

```
kubectl apply -f mutual-tls.yaml
```

> Back to the sleep container session

Check the API again:

```
curl http://details.default.svc.cluster.local:9080/details/100
```

> And check http://localhost/productpage

## 1.3 Apply mTLS for client and service

Add [default destination rule for mTLS](mutual-tls-istio-auth.yaml):

```
kubectl apply -f mutual-tls-istio-auth.yaml
```

> Back to the sleep container session

Check the API again:

```
curl http://details.default.svc.cluster.local:9080/details/100
```

> And check http://localhost/productpage

## 1.4 Dig into the TLS certs

Connect the product page proxy:

```
docker container ls --filter name=istio-proxy_productpage

docker container exec -it $(docker container ls --filter name=istio-proxy_productpage --format '{{ .ID}}') sh
```

Access the details API:

```
curl http://details:9080/details/100

curl https://details:9080/details/100

curl -k https://details:9080/details/100
```

Check the certs generated by Istio:

```
ls /etc/certs

curl -k https://details:9080/details/100 --key /etc/certs/key.pem --cert /etc/certs/cert-chain.pem --cacert /etc/certs/root-cert.pem

cat /etc/certs/cert-chain.pem | openssl x509 -text -noout  | grep Validity -A 2

cat /etc/certs/cert-chain.pem | openssl x509 -text -noout  | grep 'Subject Alternative Name' -A 1
```

## 1.5 Hack details API from product page


**This mTLS setup doesn't secure from end-user attack**

Run a shell in the product page container:

```
docker container ls --filter name=k8s_productpage

docker container exec -it $(docker container ls --filter name=k8s_productpage --format '{{ .ID}}') sh
```

Access the details API:

```
ls /etc/certs

curl http://details:9080/details/100

python
import urllib.request
urllib.request.urlopen("http://details:9080/details/100").read()
quit()

exit
```